# ==========================================
# GOD TIER TMUX CONFIG
# ==========================================

# Terminal & Color Settings (True Color + Terminal Colors)
set -g default-terminal "tmux-256color"
set -sa terminal-features ",xterm-256color:RGB"
set -sa terminal-overrides ",*-256col*:RGB"
set -ga terminal-overrides '*:Ss=\E[%p1%d q:Se=\E[ q' # Cursor shape

# ==========================================
# Core Settings
# ==========================================

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# Enable mouse support (scroll, copy, resize)
set -g mouse on

# Faster escape time (essential for vim)
set -sg escape-time 0
set -g focus-events on

# Increase history limit
set -g history-limit 100000

# Don't detach when destroying last window of session
set -g detach-on-destroy off

# Aggressive resize for shared sessions
setw -g aggressive-resize on

# ==========================================
# Key Bindings (Vim-Style)
# ==========================================

# Change prefix to Ctrl+Space (easy access, no conflicts)
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# Quick reload
bind r source-file ~/.tmux.conf \; display-message "Config Reloaded ⚡"

# Split panes (intuitive) - open in current directory
unbind '"'
unbind %
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind _ split-window -v -c "#{pane_current_path}" # Alternative

# New window in current directory
bind c new-window -c "#{pane_current_path}"

# Vim-style pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Alt + arrow keys for pane switching (no prefix)
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# Alt + number to switch windows instantly
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Shift + Alt + arrows to switch windows
bind -n M-H previous-window
bind -n M-L next-window

# Pane resizing with Prefix + vim keys
bind -r H resize-pane -L 2
bind -r J resize-pane -D 2
bind -r K resize-pane -U 2
bind -r L resize-pane -R 2

# Zoom pane toggle with 'z'
bind z resize-pane -Z

# Smart pane swapping (Prefix + > or <)
bind > swap-pane -D
bind < swap-pane -U

# Kill window/pane without confirmation
bind X kill-window
bind x kill-pane

# Swap windows left/right (Prefix + Shift+Left/Right)
bind -r S-Left swap-window -t -1 \; previous-window
bind -r S-Right swap-window -t +1 \; next-window

# Enter copy mode with 'v'
bind v copy-mode
bind / copy-mode \; send-key ? # Search up

# ==========================================
# Copy Mode (Vim Style)
# ==========================================

setw -g mode-keys vi

# Visual selection and yanking
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send -X cancel

# Scroll speed
bind -T copy-mode-vi WheelUpPane send -N3 -X scroll-up
bind -T copy-mode-vi WheelDownPane send -N3 -X scroll-down

# Double click to select word, triple click to select line
bind -T copy-mode-vi DoubleClick1Pane select-pane \; send -X select-word
bind -T copy-mode-vi TripleClick1Pane select-pane \; send -X select-line

# ==========================================
# Aesthetic Status Bar (Transparent/Nord Style)
# ==========================================

# Use terminal colors for transparency, or specific theme
set -g status-position bottom
set -g status-justify centre
set -g status-interval 1

# Lengths
set -g status-left-length 100
set -g status-right-length 100

# Transparent background with terminal colors (change to 'bg=#2e3440' for Nord)
set -g status-style bg=default,fg=default

# Status left: Session name + current path
set -g status-left "#[fg=cyan,bold]  #S #[fg=white]│ #[fg=green] #(basename #{pane_current_path}) "

# Status right: Weather (optional), CPU, Memory, DateTime
set -g status-right "#[fg=yellow] #($HOME/.tmux/plugins/tmux-cpu/scripts/cpu_percent.sh) #[fg=white]│ #[fg=magenta] #($HOME/.tmux/plugins/tmux-cpu/scripts/mem_percent.sh) #[fg=white]│ #[fg=blue] %H:%M #[fg=white]│ #[fg=cyan] %a %d %b"

# Window status
setw -g window-status-format "#[fg=default] #I:#W "
setw -g window-status-current-format "#[fg=black,bg=cyan,bold] #I:#W "
setw -g window-status-separator ""

# Activity/Silence styling
setw -g window-status-activity-style fg=yellow,bg=default,bold
setw -g window-status-bell-style fg=red,bg=default,bold

# Pane borders
set -g pane-border-style fg=default
set -g pane-active-border-style fg=cyan

# Message styling
set -g message-style bg=default,fg=yellow,bold
set -g message-command-style bg=default,fg=cyan

# Clock mode
set -g clock-mode-colour cyan
set -g clock-mode-style 24

# ==========================================
# Smart Session Management (fzf + zoxide)
# ==========================================

# Quick session switcher (Prefix + f) - Requires tmux-sessionx or tmux-session-wizard
# Alternative: Custom fzf integration
bind f display-popup -E "zoxide query -l | fzf --reverse --height 40% | xargs -I {} tmux new-session -A -s $(basename {}) -c {}"

# Smart session creation with zoxide (Prefix + F)
bind F command-prompt -p "Session name:" "run-shell 'tmux new-session -A -s %1 -c \"$(zoxide query %1)\"'"

# Kill current session and switch to last (Prefix + Q)
bind Q run-shell "tmux switch-client -l && tmux kill-session -t \"#S\""

# ==========================================
# Popups (Tmux 3.2+)
# ==========================================

# Floating scratch terminal (Prefix + Enter)
bind Enter display-popup -E -d "#{pane_current_path}" -w 80% -h 80% "tmux new-session -A -s scratch"

# Lazygit popup (Prefix + g)
bind g display-popup -E -d "#{pane_current_path}" -w 90% -h 90% "lazygit"

# Yazi file manager popup (Prefix + e)
bind e display-popup -E -d "#{pane_current_path}" -w 90% -h 90% "yazi"

# System monitor popup (btop) (Prefix + B)
bind B display-popup -E -w 80% -h 80% "btop"

# ==========================================
# TPM Plugins
# ==========================================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
set -g @plugin 'tmux-plugins/tmux-pain-control'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'omerxx/tmux-sessionx' # Smart session manager
set -g @plugin 'omerxx/tmux-floax'    # Floating panes

# Plugin Configurations

# Resurrect - Save and restore sessions
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-vim 'session'
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-processes 'lazygit btop yazi python node'

# Continuum - Auto-save every 10 minutes
set -g @continuum-restore 'on'
set -g @continuum-save-interval '10'

# Yank - Copy to system clipboard
set -g @yank_selection_mouse 'clipboard'
set -g @yank_action 'copy-pipe-and-cancel'

# Open - Open URLs/files from tmux
set -g @open-S 'https://www.google.com/search?q='

# SessionX - Smart session manager with fzf
set -g @sessionx-bind 'o'              # Prefix + o to open
set -g @sessionx-zoxide-mode 'on'      # Use zoxide for directories
set -g @sessionx-fzf-builtin-tmux 'off' # Use popup instead
set -g @sessionx-preview-location 'right'
set -g @sessionx-preview-ratio '55%'
set -g @sessionx-window-height '85%'
set -g @sessionx-window-width '75%'

# Floax - Floating panes
set -g @floax-bind 'p'                 # Prefix + p for floating pane
set -g @floax-width '80%'
set -g @floax-height '80%'
set -g @floax-border-color 'cyan'
set -g @floax-text-color 'blue'

# Prefix Highlight - Show when prefix is active
set -g @prefix_highlight_show_copy_mode 'on'
set -g @prefix_highlight_copy_mode_attr 'fg=black,bg=yellow,bold'
set -g @prefix_highlight_show_sync_mode 'on'
set -g @prefix_highlight_sync_mode_attr 'fg=black,bg=green'

# CPU/Memory display settings
set -g @cpu_percentage_format "%5.1f%%"
set -g @ram_percentage_format "%5.1f%%"

# ==========================================
# Initialize TMUX Plugin Manager (TPM)
# ==========================================

run '~/.tmux/plugins/tpm/tpm'

# ==========================================
# Post-TPM Config (Overrides)
# ==========================================

# Ensure prefix highlight is in status bar
set -g status-left "#{prefix_highlight}#[fg=cyan,bold]  #S #[fg=white]│ #[fg=green] #(basename #{pane_current_path}) "
